# Analysis Engine 并发测试指南

## 🚀 快速开始

### 运行并发测试

```bash
cd backend/tests
python test_analysis_engine_concurrency.py
```

### 预期输出

```
🧪 Analysis Engine 并发测试
==================================================
🔍 检查Analysis Engine健康状态...
✅ Analysis Engine 健康状态正常

🚀 开始并发分析测试...
🚀 [test-01] 启动分析: 000001
🚀 [test-02] 启动分析: 000002
🚀 [test-03] 启动分析: 600036
🚀 [test-04] 启动分析: 600519
🚀 [test-05] 启动分析: 000858

📊 并发测试结果:
==================================================
总任务数: 5
成功任务: 5
失败任务: 0
成功率: 100.0%
总耗时: 180.5秒
平均任务耗时: 165.2秒
最长任务耗时: 185.3秒
最短任务耗时: 145.8秒

🎯 并发性能评估:
理论顺序执行时间: 826.0秒
实际并发执行时间: 180.5秒
并发加速比: 4.58x
✅ 并发性能良好
```

## 📊 性能指标解读

### 成功率指标

| 成功率 | 状态 | 说明 |
|--------|------|------|
| >95% | ✅ 优秀 | 系统稳定，并发处理良好 |
| 80-95% | ⚠️ 一般 | 存在偶发问题，需要关注 |
| <80% | ❌ 较差 | 系统不稳定，需要立即修复 |

### 并发加速比

| 加速比 | 状态 | 说明 |
|--------|------|------|
| >3.0x | ✅ 优秀 | 并发效果显著 |
| 1.5-3.0x | ✅ 良好 | 并发有效果 |
| 1.0-1.5x | ⚠️ 一般 | 并发效果有限 |
| <1.0x | ❌ 较差 | 存在阻塞问题 |

### 平均耗时

| 耗时 | 状态 | 说明 |
|------|------|------|
| <120s | ✅ 快速 | 分析效率高 |
| 120-300s | ⚠️ 正常 | 可接受的分析时间 |
| >300s | ❌ 缓慢 | 需要优化性能 |

## 🔧 测试配置

### 默认测试股票

```python
test_stocks = [
    "000001",  # 平安银行 - A股大盘股
    "000002",  # 万科A - 房地产龙头
    "600036",  # 招商银行 - 银行股
    "600519",  # 贵州茅台 - 消费股
    "000858"   # 五粮液 - 白酒股
]
```

### 自定义测试

```python
# 修改测试股票列表
test_stocks = ["你的股票代码1", "你的股票代码2"]

# 修改并发数量
# 在 main() 函数中调整 test_stocks 列表长度
```

## 🐛 常见问题排查

### 1. 连接失败

**错误**: `❌ 无法连接到Analysis Engine`

**解决方案**:
```bash
# 检查Analysis Engine是否启动
curl http://localhost:8001/health

# 启动Analysis Engine
cd backend/analysis-engine
python -m app.main
```

### 2. 请求验证失败

**错误**: `❌ 请求验证失败: POST /api/analysis/start`

**原因**: 请求格式不正确

**检查项**:
- `research_depth` 应该是数字 (1-5)
- `model_version` 字段名正确
- `market_type` 使用正确的枚举值 ("A股", "美股", "港股")

### 3. 分析任务失败

**错误**: `❌ 分析失败: name 'analysis_config' is not defined`

**解决方案**: 确保使用最新版本的代码，该问题已在最新版本中修复

### 4. 超时问题

**错误**: 任务长时间无响应

**排查步骤**:
1. 检查LLM Service是否正常
2. 检查Data Service是否正常
3. 查看Analysis Engine日志
4. 检查Redis连接状态

## 📈 性能优化建议

### 1. 调整并发数量

```python
# 根据系统资源调整测试股票数量
# 推荐配置:
# - 开发环境: 2-3个股票
# - 测试环境: 5-8个股票  
# - 生产环境: 根据实际负载调整
```

### 2. 监控系统资源

```bash
# 监控CPU和内存使用
htop

# 监控Redis连接
redis-cli info clients

# 监控网络连接
netstat -an | grep :8001
```

### 3. 优化分析配置

```python
# 使用较轻的分析配置进行并发测试
analysis_request = {
    "research_depth": 2,  # 降低研究深度
    "news_analyst": False,  # 关闭新闻分析
    "social_analyst": False,  # 关闭社交分析
}
```

## 🎯 测试最佳实践

### 1. 定期测试

- **每日**: 快速并发测试 (2-3个股票)
- **每周**: 标准并发测试 (5个股票)
- **每月**: 压力测试 (10+个股票)

### 2. 测试环境

- 确保所有微服务正常运行
- 使用稳定的网络环境
- 避免在高负载时段测试

### 3. 结果记录

```bash
# 保存测试结果
python test_analysis_engine_concurrency.py > concurrency_test_$(date +%Y%m%d_%H%M%S).log
```

### 4. 性能基准

建立性能基准数据，定期对比：

```
# 基准数据示例 (2025-07-26)
成功率: 100%
并发加速比: 4.58x
平均耗时: 165.2s
```

## 📝 报告模板

### 测试报告格式

```
并发测试报告 - YYYY-MM-DD
================================
测试环境: [开发/测试/生产]
测试股票: [股票代码列表]
并发数量: X个

结果:
- 成功率: XX%
- 并发加速比: X.XXx
- 平均耗时: XXXs
- 状态: [优秀/良好/一般/较差]

问题:
- [列出发现的问题]

建议:
- [优化建议]
```

---

**维护说明**: 
- 定期更新测试股票列表
- 根据系统变更调整性能基准
- 记录重要的测试结果和问题
